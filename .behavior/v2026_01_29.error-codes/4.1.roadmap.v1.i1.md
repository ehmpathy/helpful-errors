# roadmap: error codes

> checklist for execution with acceptance verification at each step

---

## phase 0: preparation

### read before start

- [ ] .behavior/v2026_01_29.error-codes/0.wish.md
- [ ] .behavior/v2026_01_29.error-codes/1.vision.md
- [ ] .behavior/v2026_01_29.error-codes/2.1.criteria.blackbox.md
- [ ] .behavior/v2026_01_29.error-codes/2.3.criteria.blueprint.md
- [ ] .behavior/v2026_01_29.error-codes/3.3.blueprint.v1.i1.md

### acceptance

- [ ] builder understands the wish, vision, and criteria
- [ ] builder understands the blueprint contracts and composition

### verification

```sh
# none — human verification
```

---

## phase 1: type and static code

> add HelpfulErrorCode type and static code properties

### read before phase

- [ ] .behavior/v2026_01_29.error-codes/3.3.blueprint.v1.i1.md (contracts section)

### checklist

- [ ] 1.1: add `HelpfulErrorCode` type to src/HelpfulError.ts
- [ ] 1.2: add `static code: HelpfulErrorCode | undefined = undefined` to HelpfulError
- [ ] 1.3: add `static code = { http: 400 } as const` to BadRequestError
- [ ] 1.4: add `static code = { http: 500 } as const` to UnexpectedCodePathError
- [ ] 1.5: export `HelpfulErrorCode` type from src/index.ts

### acceptance criteria

```
given('HelpfulError class')
  then('HelpfulError.code is undefined')

given('BadRequestError class')
  then('BadRequestError.code is { http: 400 }')

given('UnexpectedCodePathError class')
  then('UnexpectedCodePathError.code is { http: 500 }')

given('index.ts exports')
  then('HelpfulErrorCode type is exported')
```

### verification

```sh
npm run test:types
```

---

## phase 2: constructor and original storage

> update constructor to handle code in metadata

### read before phase

- [ ] .behavior/v2026_01_29.error-codes/3.3.blueprint.v1.i1.md (contracts section)

### depends on

- [x] phase 1 complete

### checklist

- [ ] 2.1: update `original` private type to include `code?: HelpfulErrorCode | null`
- [ ] 2.2: update constructor to extract `code` from metadata and store in `original.code`
- [ ] 2.3: update `metadataWithoutCause` to also omit `code` (for message serialization)

### acceptance criteria

```
given('error thrown with code in metadata')
  then('code is stored in original.code')
  then('code does not appear in error.message')

given('error thrown with code: null in metadata')
  then('original.code is null')

given('error thrown without code in metadata')
  then('original.code is undefined')
```

### verification

```sh
npm run test:types
```

---

## phase 3: code getter

> implement the code getter with merge logic

### read before phase

- [ ] .behavior/v2026_01_29.error-codes/3.3.blueprint.v1.i1.md (contracts section, composition section)

### depends on

- [x] phase 2 complete

### checklist

- [ ] 3.1: implement `get code(): HelpfulErrorCode | undefined` on HelpfulError
- [ ] 3.2: getter reads static code from `this.constructor`
- [ ] 3.3: getter reads instance code from `this.original.code`
- [ ] 3.4: getter returns undefined if `original.code === null` (explicit opt-out)
- [ ] 3.5: getter merges class + instance (instance fields override)
- [ ] 3.6: getter returns undefined if no code anywhere

### acceptance criteria

```
given('HelpfulError instance')
  when('no code supplied')
    then('error.code is undefined')

given('BadRequestError instance')
  when('no code supplied')
    then('error.code.http is 400')
    then('error.code.slug is undefined')

given('BadRequestError instance')
  when('code: { slug: "X" } supplied')
    then('error.code.http is 400')
    then('error.code.slug is "X"')

given('BadRequestError instance')
  when('code: { http: 422, slug: "X" } supplied')
    then('error.code.http is 422')
    then('error.code.slug is "X"')

given('BadRequestError instance')
  when('code: null supplied')
    then('error.code is undefined')
```

### verification

```sh
npm run test:types
```

---

## phase 4: metadata getter update

> update metadata getter to exclude code field

### read before phase

- [ ] .behavior/v2026_01_29.error-codes/3.3.blueprint.v1.i1.md (metadata isolation section)

### depends on

- [x] phase 3 complete

### checklist

- [ ] 4.1: update `get metadata()` to omit `code` field from returned metadata

### acceptance criteria

```
given('error thrown with { code: { slug: "X" }, userId: 123 }')
  then('error.metadata is { userId: 123 }')
  then('error.metadata does not contain code')
  then('error.code.slug is "X"')
```

### verification

```sh
npm run test:types
```

---

## phase 5: serialization

> update toJSON to conditionally include code

### read before phase

- [ ] .behavior/v2026_01_29.error-codes/3.3.blueprint.v1.i1.md (toJSON contract, serialization flow)
- [ ] .behavior/v2026_01_29.error-codes/1.vision.md (serialization section)

### depends on

- [x] phase 4 complete

### checklist

- [ ] 5.1: update `toJSON()` to check `this.code?.slug`
- [ ] 5.2: if slug present, include `code` in output object
- [ ] 5.3: if slug absent, omit `code` from output object

### acceptance criteria

```
given('BadRequestError instance')
  when('no slug supplied')
    then('JSON.stringify does not include code')

given('BadRequestError instance')
  when('slug supplied')
    then('JSON.stringify includes code with http and slug')

given('custom error class with static code = { http: 402, slug: "DECLINED:PAYMENT" }')
  when('instance serialized')
    then('JSON.stringify includes code')
```

### verification

```sh
npm run test:types
```

---

## phase 6: unit tests — HelpfulError

> add unit tests for code functionality on HelpfulError

### read before phase

- [ ] .behavior/v2026_01_29.error-codes/3.3.blueprint.v1.i1.md (test coverage section)
- [ ] src/HelpfulError.test.ts (prior test patterns)

### depends on

- [x] phase 5 complete

### checklist

- [ ] 6.1: add `describe('code')` block
- [ ] 6.2: add tests for getter (undefined, class code, instance code, merge, null opt-out)
- [ ] 6.3: add tests for static code (HelpfulError.code is undefined)
- [ ] 6.4: add tests for serialization (omit when no slug, include when slug)
- [ ] 6.5: add tests for metadata isolation (code not in metadata, code not in message)
- [ ] 6.6: add tests for inheritance (subclass inherits, subclass overrides, multi-level)

### acceptance criteria

```
given('HelpfulError.test.ts')
  then('all code-related tests pass')
  then('tests cover getter, static, serialization, isolation, inheritance')
```

### verification

```sh
npm run test:unit -- HelpfulError.test.ts
```

---

## phase 7: unit tests — BadRequestError

> add unit tests for code functionality on BadRequestError

### read before phase

- [ ] .behavior/v2026_01_29.error-codes/3.3.blueprint.v1.i1.md (test coverage section)
- [ ] src/BadRequestError.test.ts (prior test patterns)

### depends on

- [x] phase 6 complete

### checklist

- [ ] 7.1: add `describe('code')` block
- [ ] 7.2: add test for static code = { http: 400 }
- [ ] 7.3: add test for instance.code.http is 400
- [ ] 7.4: add test for instance.code.slug is undefined by default
- [ ] 7.5: add test for instance can override with slug
- [ ] 7.6: add test for instance can override http
- [ ] 7.7: add test for toJSON omits code (no slug by default)
- [ ] 7.8: add test for toJSON includes code when slug supplied

### acceptance criteria

```
given('BadRequestError.test.ts')
  then('all code-related tests pass')
  then('tests cover static code, getter, override, serialization')
```

### verification

```sh
npm run test:unit -- BadRequestError.test.ts
```

---

## phase 8: unit tests — UnexpectedCodePathError

> add unit tests for code functionality on UnexpectedCodePathError

### read before phase

- [ ] .behavior/v2026_01_29.error-codes/3.3.blueprint.v1.i1.md (test coverage section)
- [ ] src/UnexpectedCodePathError.test.ts (prior test patterns)

### depends on

- [x] phase 7 complete

### checklist

- [ ] 8.1: add `describe('code')` block
- [ ] 8.2: add test for static code = { http: 500 }
- [ ] 8.3: add test for instance.code.http is 500
- [ ] 8.4: add test for instance.code.slug is undefined by default
- [ ] 8.5: add test for instance can override with slug
- [ ] 8.6: add test for toJSON omits code (no slug by default)

### acceptance criteria

```
given('UnexpectedCodePathError.test.ts')
  then('all code-related tests pass')
  then('tests cover static code, getter, override, serialization')
```

### verification

```sh
npm run test:unit -- UnexpectedCodePathError.test.ts
```

---

## phase 9: backwards compatibility tests

> verify prior behavior is unchanged

### read before phase

- [ ] .behavior/v2026_01_29.error-codes/2.1.criteria.blackbox.md (usecase.9)
- [ ] src/HelpfulError.test.ts (prior backwards compatibility tests)

### depends on

- [x] phase 8 complete

### checklist

- [ ] 9.1: verify prior error instantiation patterns still work
- [ ] 9.2: verify error.message unchanged for errors without code
- [ ] 9.3: verify error.metadata unchanged for non-code metadata
- [ ] 9.4: verify snapshots still match (or update if intentional)

### acceptance criteria

```
given('prior error patterns')
  then('all prior tests pass without modification')
  then('error.message unchanged')
  then('error.metadata unchanged')
```

### verification

```sh
npm run test:unit
```

---

## phase 10: full validation

> run all checks and verify criteria satisfaction

### read before phase

- [ ] .behavior/v2026_01_29.error-codes/2.1.criteria.blackbox.md (all usecases)
- [ ] .behavior/v2026_01_29.error-codes/2.2.criteria.blackbox.matrix.md (all matrices)

### depends on

- [x] phase 9 complete

### checklist

- [ ] 10.1: run type checks
- [ ] 10.2: run all unit tests
- [ ] 10.3: run lint checks
- [ ] 10.4: run format checks
- [ ] 10.5: verify all blackbox criteria satisfied

### acceptance criteria

```
given('full test suite')
  then('npm run test:types passes')
  then('npm run test:unit passes')
  then('npm run test:lint passes')
  then('npm run test:format passes')

given('blackbox criteria')
  then('usecase.1 (extract code) satisfied')
  then('usecase.2 (default codes) satisfied')
  then('usecase.3 (supply code at throw) satisfied')
  then('usecase.4 (class baked-in code) satisfied')
  then('usecase.5 (inheritance) satisfied')
  then('usecase.6 (merge semantics) satisfied')
  then('usecase.7 (partial codes) satisfied')
  then('usecase.8 (serialization) satisfied')
  then('usecase.9 (backwards compat) satisfied')
```

### verification

```sh
npm run test:types && npm run test:unit && npm run test:lint && npm run test:format
```

---

## phase 11: cleanup and commit

> finalize changes

### depends on

- [x] phase 10 complete

### checklist

- [ ] 11.1: review all changes
- [ ] 11.2: update snapshots if needed (`RESNAP=true npm run test:unit`)
- [ ] 11.3: stage changes
- [ ] 11.4: commit with descriptive message

### acceptance criteria

```
given('all changes')
  then('git status shows only expected files')
  then('commit message describes the feature')
```

### verification

```sh
git status
git diff --staged
```

---

## summary

| phase | description | depends on | verification |
|-------|-------------|------------|--------------|
| 0 | preparation | — | human |
| 1 | type and static code | — | test:types |
| 2 | constructor and original storage | 1 | test:types |
| 3 | code getter | 2 | test:types |
| 4 | metadata getter update | 3 | test:types |
| 5 | serialization | 4 | test:types |
| 6 | unit tests — HelpfulError | 5 | test:unit |
| 7 | unit tests — BadRequestError | 6 | test:unit |
| 8 | unit tests — UnexpectedCodePathError | 7 | test:unit |
| 9 | backwards compatibility | 8 | test:unit |
| 10 | full validation | 9 | all tests |
| 11 | cleanup and commit | 10 | git status |
