# execution: metadata-getter

## phase.1 = core HelpfulError changes

### task.1.1 = add generic type parameter to HelpfulError class
- [x] **execute:** modify class declaration in `src/HelpfulError.ts`
- **status:** done

### task.1.2 = update constructor signature
- [x] **execute:** change `metadata?: HelpfulErrorMetadata` to `metadata?: TMetadata`
- **status:** done

### task.1.3 = update private original property type
- [x] **execute:** change `metadata?: HelpfulErrorMetadata` to `metadata?: TMetadata` in original type
- **status:** done

### task.1.4 = add public metadata getter
- [x] **execute:** add `public get metadata(): TMetadata | undefined` to HelpfulError
- **status:** done

### task.1.5 = update static throw method signature
- [x] **execute:** change metadata type to infer from instance type
- **status:** done

### task.1.6 = verify HelpfulError prior tests pass
- [x] **execute:** run tests for HelpfulError
- **status:** done

---

## phase.2 = subclass updates

### task.2.1 = update BadRequestError subclass
- [x] **execute:** add generic type parameter to BadRequestError
- **status:** done

### task.2.2 = update UnexpectedCodePathError subclass
- [x] **execute:** add generic type parameter to UnexpectedCodePathError
- **status:** done

### task.2.3 = verify all prior tests pass
- [x] **execute:** run full test suite
- **status:** done

---

## phase.3 = metadata getter tests

### task.3.1 = add metadata getter tests
- [x] **execute:** add `describe('metadata', ...)` block
- **status:** done

---

## phase.4 = typed generic constraint tests

### task.4.1 = add typed generic constraint tests
- [x] **execute:** add `describe('typed metadata generic', ...)` block
- **status:** done

### task.4.2 = add backwards compatibility tests
- [x] **execute:** add `describe('backwards compatibility', ...)` block
- **status:** done

---

## phase.5 = subclass typed metadata tests

### task.5.1 = add BadRequestError typed metadata tests
- [x] **execute:** add typed metadata tests to BadRequestError.test.ts
- **status:** done

### task.5.2 = add UnexpectedCodePathError typed metadata tests
- [x] **execute:** add typed metadata tests to UnexpectedCodePathError.test.ts
- **status:** done

---

## phase.6 = final verification

### task.6.1 = run full test suite
- [x] **execute:** `npm run test`
- **status:** done - 46 tests pass

### task.6.2 = run full type check
- [x] **execute:** `npm run test:types`
- **status:** done - no type errors

### task.6.3 = run lint check
- [x] **execute:** `npm run test:lint`
- **status:** done - no lint errors

### task.6.4 = run build
- [x] **execute:** `npm run build`
- **status:** done - build succeeded

---

## log

### 2026-01-28 - phase.1 execution

task.1.1-1.5: implemented HelpfulError generic changes
- added `<TMetadata extends HelpfulErrorMetadata = HelpfulErrorMetadata>` to class
- updated constructor to accept `TMetadata`
- updated `original` property type to use `TMetadata`
- added public `metadata` getter
- updated static `throw` method with type inference

task.1.6: verified types pass

### 2026-01-28 - phase.2 execution

task.2.1: updated BadRequestError with generic parameter
task.2.2: updated UnexpectedCodePathError with generic parameter
task.2.3: fixed inline CustomError in test file, all types pass

### 2026-01-28 - phase.3-5 execution

task.3.1: added metadata getter tests (4 tests)
- return metadata object
- return undefined when no metadata
- not in Object.keys enumeration
- no redundant serialization

task.4.1: added typed generic constraint tests (4 tests)
- constrain metadata input
- typed access to properties
- nested typed metadata
- constrain on static throw

task.4.2: added backwards compatibility tests (2 tests)
- works without generic
- allows cause in metadata

task.5.1: added BadRequestError typed metadata tests (2 tests)
task.5.2: added UnexpectedCodePathError typed metadata tests (2 tests)

### 2026-01-28 - phase.6 final verification

- all 46 tests pass
- no type errors
- no lint errors
- build succeeded

### note: linter fix reverted

the linter auto-"fixed" `new this(...)` to `new HelpfulError(...)` which broke polymorphism.
manually reverted to preserve correct behavior in:
- `HelpfulError.throw()` method
- `HelpfulError.wrap()` method

---

## phase.7 = conditional metadata requirement

### task.7.1 = TDD: write tests first
- [x] **execute:** add tests for conditional metadata requirement
- **status:** done

### task.7.2 = implement conditional optionality
- [x] **execute:** update constructor signatures via rest parameter tuple pattern
- **status:** done

### task.7.3 = update subclasses
- [x] **execute:** update BadRequestError and UnexpectedCodePathError constructors
- **status:** done

### task.7.4 = final verification
- [x] **execute:** run full test suite
- **status:** done - 50 tests pass

---

## log (continued)

### 2026-01-28 - phase.7 execution

task.7.1: added TDD tests for conditional metadata requirement (3 tests)
- require metadata when TMetadata is specific
- not need optional chain on metadata when type is specific
- require metadata on static throw for specific types

task.7.2: implemented conditional optionality via rest parameter tuple:
```ts
constructor(
  message: string,
  ...[metadata]: HelpfulErrorMetadata extends TMetadata
    ? [metadata?: TMetadata]  // default type - optional
    : [metadata: TMetadata]   // specific type - required
) {
```

task.7.3: updated BadRequestError and UnexpectedCodePathError with same pattern

task.7.4: verified all 50 tests pass, types pass, lint pass, build succeeded

### note: linter fix reverted (again)
the linter auto-"fixed" `new this(...)` and `variant: this` again - manually reverted both

---

## phase.8 = simplify subclass constructor requirements for .wrap()

### task.8.1 = relax type constraint on static methods
- [x] **execute:** change `T extends typeof HelpfulError` to `T extends HelpfulErrorConstructor`
- **status:** done

### task.8.2 = export HelpfulErrorConstructor type
- [x] **execute:** add `export type HelpfulErrorConstructor` to HelpfulError.ts
- **status:** done

### task.8.3 = update withHelpfulError to import type
- [x] **execute:** import `HelpfulErrorConstructor` from HelpfulError.ts
- **status:** done

### task.8.4 = disable noThisInStatic lint rule
- [x] **execute:** set `"noThisInStatic": "off"` in biome.jsonc
- **status:** done

### task.8.5 = final verification
- [x] **execute:** run full test suite
- **status:** done - 50 tests pass

---

## log (continued)

### 2026-01-28 - phase.8 execution

problem: subclasses needed to repeat the complex rest tuple constructor pattern for `.wrap()` to work.

solution: relax the type constraint from `T extends typeof HelpfulError` to `T extends HelpfulErrorConstructor` where:
```ts
export type HelpfulErrorConstructor = new (
  message: string,
  metadata?: any,
) => HelpfulError<any>;
```

this allows subclasses to use simple constructors while `.wrap()` still works:
```ts
class CustomError extends HelpfulError {
  constructor(message: string, metadata?: HelpfulErrorMetadata) {
    super(['CustomError: ', message].join(''), metadata);
  }
}

// now works without complex constructor pattern
CustomError.wrap(fn, { message: '...', metadata: {} })
```

also disabled `noThisInStatic` lint rule in biome.jsonc to prevent biome from auto-fix of `this` to explicit class name, which broke polymorphism.
